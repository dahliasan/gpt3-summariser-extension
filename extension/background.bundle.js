(()=>{console.log("hello this is the background script!");async function e(e,t){const o=t||async function(){let[e]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});return e}();console.log("sending injection message to:",o),chrome.tabs.sendMessage(o.id,{type:"inject",message:e},(e=>{"failed"===e.status&&console.log("injection failed.")}))}async function t(t,s,a){try{e({content:"generating..."},a);const s=await async function(e,t){const o=await new Promise((e=>{chrome.storage.local.get(["uniqueUserId"],(t=>{if(t.uniqueUserId)e(t.uniqueUserId);else{const t=Date.now().toString()+Math.random().toString(36).substring(2,15);chrome.storage.local.set({uniqueUserId:t},(()=>{e(t)}))}}))})),n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer wVcIxPHJadXQotPGPgjR5"},body:JSON.stringify({variables:{text:e},user:o})}),s=await n.json();if(console.log("API replied:",s),"error"===s.object)throw s.message;return s.choices.pop()}(t,"https://www.everyprompt.com/api/v0/calls/personal-17/detailed-summary-and-advice-pZMlOa");let r={date:Date.now(),title:a.title,url:a.url,content:s.text};e(r,a);const i=await n(`${s.text} \n\n ${r.title} \n\n ${r.url}`);let c=await o();console.log("this summary's id is: ",c),r={...r,id:c,embedding:i},chrome.storage.local.set({[`summary-${c}`]:r},(function(){console.log("Summary saved to local storage",r)}))}catch(t){console.log(t),e(t)}}async function o(){let e=await new Promise((e=>chrome.storage.local.get(["summaryIndex"],e))),t=e.summaryIndex?e.summaryIndex+1:1;return await new Promise((e=>chrome.storage.local.set({summaryIndex:t},e))),t}async function n(e){const t=await async function(){return new Promise(((e,t)=>{chrome.storage.local.get(["openai-key"],(t=>{if(t["openai-key"]){const o=atob(t["openai-key"]);e(o)}}))}))}(),o=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"text-embedding-ada-002",input:e})}),n=await o.json();if(console.log("embeddings response: ",n),n.error)throw n.error.message;return n.data[0].embedding}function s(e,t){if(!e||!t)throw console.log("vecA: ",e),console.log("vecB: ",t),new Error("Input vectors are not defined");const o=e=>{let t=0;for(let o=0;o<e.length;o++)t+=e[o]*e[o];return Math.sqrt(t)};return((e,t)=>{let o=0;for(let n=0;n<e.length;n++)o+=e[n]*t[n];return o})(e,t)/(o(e)*o(t))}function a(){chrome.storage.local.get(null,(async e=>{for(const t in e)if(t.includes("summary")&&!t.includes("summaryIndex")){const s=e[t];if(!s.embedding||!s.id){console.log("summary missing embedding or id",s);const e=await o(),a={...s,id:e,embedding:n(`${s.content} \n\n ${s.title} \n\n ${s.url} `)};chrome.storage.local.remove(t),chrome.storage.local.set({[`summary-${a.id}`]:a})}}console.log(e)}))}chrome.runtime.onMessage.addListener(((e,o,a)=>{e.text&&(console.log("Received input: "+e.text),t(e.text,e.info,e.tab)),e.searchValue&&async function(e){try{const t=await new Promise((e=>{chrome.storage.local.get(null,(t=>{e(t)}))}));let o;for(const n in t)if(n.includes("searchQuery")){const s=t[n];if(s.query===e){console.log("query already exists"),chrome.storage.local.remove(n),o=s.embedding;break}}console.log(o),o||(console.log("running getEmbeddings"),o=await n(e));let a={date:Date.now(),query:e,embedding:o};chrome.storage.local.get(null,(e=>{let t=[];for(const n in e)if(n.includes("summary")&&!n.includes("summaryIndex")){const a=e[n];console.log(a);const r=s(o,a.embedding);t.push({...a,similarity:r})}t.sort(((e,t)=>t.similarity-e.similarity)),a={...a,results:t},chrome.storage.local.set({[`searchQuery-${Date.now()}`]:a},(function(){console.log("Search query and results saved to local storage",a)})),console.log(t),chrome.runtime.sendMessage({type:"search_results",searchResults:t})}))}catch(e){console.log(e)}}(e.searchValue)})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"gpt-summarise",title:"Generate summary",contexts:["all"]}),chrome.tabs.create({url:"https://fxhd.notion.site/TLDR-Summariser-Chrome-Extension-317ba7f2f1c5443cbc99a220c5d073b0"}),a();const e=Date.now().toString()+Math.random().toString(36).substring(2,15);chrome.storage.local.set({uniqueUserId:e},(()=>{console.log("Unique user ID stored in chrome.storage.local: "+e)}))})),chrome.contextMenus.onClicked.addListener(((e,o)=>{e.selectionText?t(e.selectionText,0,o):chrome.tabs.sendMessage(o.id,{message:"get_email"},(e=>{console.log("Entire email content received: ",e),t(e.text,0,o)}))})),chrome.runtime.onStartup.addListener((()=>{a()}))})();